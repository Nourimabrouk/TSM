<<<<<<< Updated upstream
library(here)
source("Functions.R")
source("Plotting.R")
library(tidyverse)
library(lubridate)
options(warn=-1)
# Data import--------
ts_flights
df_flights <- read_csv(here('Data', 'total-number-of-flights.csv'))
dates = df_flights %>% slice(32:131) %>% select(1) %>% transmute(date = as.Date(DateTime, format="%d/%m/%y")) %>% pull()
ts_flights <-  df_flights%>%
select(2) %>% slice(32:131) %>% ts()
phi_ini <- 0
param_hat <- kalman_parameter_optimizer(ts_flights, phi_ini)
sig_eps <- param_hat[2]
sig_eta <- param_hat[3]
a_ini <- 0
P_ini <- 10^5
theta <- c(a_ini, P_ini)
#2.1
df_kalman_filtered_state <- kalman_filter(ts_flights, theta, sig_eps, sig_eta)
#2.2
df_smoothed_state <- smoothed_state(ts_flights, df_kalman_filtered_state)
#2.3
df_disturbance <- disturbances_smoothing(df_kalman_filtered_state, df_smoothed_state)
#2.5
missing_values_index <- c(21:40, 61:80)
df_data_missing <- ts_flights
df_data_missing[missing_values_index] <- NA
df_kalman_missing_data <- kalman_filter(df_data_missing, theta, sig_eps, sig_eta)
df_smoothed_state_missing_data <- smoothed_state(df_data_missing, df_kalman_missing_data)
df_disturbance_missing_data <- disturbances_smoothing(df_kalman_missing_data, df_smoothed_state_missing_data)
#2.6
n_steps <- 30
df_forecasts <- one_step_forecasting(df_kalman_filtered_state, n_steps)
#2.7
df_predictionerrors <- prediction_errors(df_kalman_filtered_state$v, df_kalman_filtered_state$F)
#2.8
df_st_residuals <- stand_smooth_residuals(df_kalman_filtered_state$F,df_kalman_filtered_state$v,
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
#Plot results
plotOne(ts_flights[-1,], df_kalman_filtered_state[-1,])
plotTwo(ts_flights, df_smoothed_state)
plotThree(df_disturbance %>% slice(-c(1,2)))
plotFive(df_data_missing[-1,], df_kalman_missing_data %>% slice(-1), df_smoothed_state_missing_data %>% slice(-1))
plotSix(ts_flights[-1,], df_kalman_filtered_state[-1,], df_forecasts[-1,])
plotSeven(df_predictionerrors %>% slice(-c(1:2)))
plotEight(df_st_residuals %>% slice(-1), df_predictionerrors %>% slice(-1))
plotOne <- function(df_data, df_kf){
"
Goal: Plot figure 2.1
Input: df_kalman_filtered_state
Output: Plot 2.1
"
n <- nrow(df_kf)
y <- as.matrix(df_data)[2:n]
filtered_state <- df_kf$a[2:n]
filtered_state_lb <- df_kf$a_lb[2:n]
filtered_state_ub <- df_kf$a_ub[2:n]
filtered_variance <- df_kf$P[2:n]
state_error <- df_kf$v[2:n]
state_error_variance <- df_kf$F[2:n]
par(mfrow=c(2,2),mar=c(4.1,4.1,1.1,2.1))
plot(makeTS(filtered_state, 2), lot.type="single", ylab="", xlab="", main = "(i)",font.main=1, cex.main=1,  ylim=create_ylim(y))
lines(makeTS(filtered_state_lb, 2), col="red")
lines(makeTS(filtered_state_ub, 2), col="red")
points(makeTS(y, 2), pch=20)
plot(makeTS(filtered_variance, 2), plot.type="single", ylab="", xlab="", main = "(ii)",font.main=1, cex.main=1,  ylim=create_ylim(filtered_variance))
plot(makeTS(state_error, 2), plot.type="single", ylab="", xlab="Days", main="(iii)",font.main=1, cex.main=1,  ylim=create_ylim(state_error))
abline(h=0,col="red")
plot(makeTS(state_error_variance, 2), plot.type="single", ylab="", xlab="Days", main = "(iv)",font.main=1, cex.main=1,  ylim=create_ylim(state_error_variance))
}
plotTwo <- function(df_data, df_sm){
"
Goal: Plot figure 2.4
Input: df_smoothed_state
Output: Plot 2.4
"
n <- nrow(df_sm)
y <- as.matrix(df_data)[2:n]
smooth_state <- df_sm$alpha[2:n]
smooth_state_lb <- df_sm$alpha_lb[2:n]
smooth_state_ub <- df_sm$alpha_ub[2:n]
smooth_variance <- df_sm$V[2:n]
state_error <- df_sm$r[2:(n-1)]
state_error_variance <- df_sm$N[2:(n-1)]
par(mfrow=c(2,2),mar=c(4.1,4.1,1.1,2.1))
plot(makeTS(smooth_state, 2), plot.type="single", ylab="", xlab="", main = "(i)",font.main=1, cex.main=1,  ylim=create_ylim(y))
lines(makeTS(smooth_state_lb, 2), col="red")
lines(makeTS(smooth_state_ub, 2), col="red")
points(makeTS(y, 2), pch=20)
plot(makeTS(smooth_variance, 2), plot.type="single", ylab="", xlab="", main = "(ii)",font.main=1, cex.main=1,  ylim=create_ylim(smooth_variance[2:n]))
plot(makeTS(state_error, 2), plot.type="single", ylab="", xlab="Days", main = "(iii)",font.main=1, cex.main=1,  ylim=create_ylim(state_error))
abline(h=0,col="red")
plot(makeTS(state_error_variance, 2), plot.type="single", ylab="", xlab="Days", main = "(iv)",font.main=1, cex.main=1,  ylim=create_ylim(state_error_variance))
}
plotThree <- function(df){
"
Goal: Plot figure 2.3
Input: df_disturbance
Output: Plot 2.3
"
n <- nrow(df)
observation_error <- df$eps[1:n]
observation_error_variance <- df$sd_eps[1:n]
state_error <- df$eta[1:n]
state_error_variance <- df$sd_eta[1:n]
par(mfrow=c(2,2),mar=c(4.1,4.1,1.1,2.1))
plot(makeTS(observation_error, 2), plot.type="single", ylab="", xlab="", main = "(i)",font.main=1, cex.main=1,  ylim=create_ylim(observation_error))
abline(h=0, col="red")
plot(makeTS(observation_error_variance, 2), plot.type="single", ylab="", xlab="", main = "(ii)",font.main=1, cex.main=1,  ylim=create_ylim(observation_error_variance))
plot(makeTS(state_error, 2), plot.type="single", ylab="", xlab="Days", main = "(iii)",font.main=1, cex.main=1,  ylim=create_ylim(state_error))
abline(h=0, col="red")
plot(makeTS(state_error_variance, 2), plot.type="single", ylab="", xlab="Days", main = "(iv)",font.main=1, cex.main=1,  ylim=create_ylim(state_error_variance))
}
plotFive <- function(df_data, df_k, df_s){
"
Goal: Plot figure 2.5
Input: df_data, df_kalman_missing_data, df_smoothed_missing_data
Output: Plot 2.5
"
n <- length(df_data)
filtered_state <- df_k$a[2:n]
filtered_variance <- df_k$P[2:n]
smoothed_state <- df_s$alpha[2:n]
smoothed_state_variance <- df_s$V[2:n]
par(mfrow=c(2,2),mar=c(4.1,4.1,1.1,2.1))
plot(makeTS(filtered_state, 2), col="red", plot.type="single", ylab="", xlab="", main = "(i)",font.main=1, cex.main=1,  ylim=create_ylim(df_data))
lines(makeTS(df_data, 2))
plot(makeTS(filtered_variance, 2), plot.type="single", ylab="", xlab="", main = "(ii)",font.main=1, cex.main=1,  ylim=create_ylim(filtered_variance))
plot(makeTS(smoothed_state, 2), col="red", plot.type="single", ylab="", xlab="Days", main = "(iii)", font.main=1, cex.main=1,  ylim=create_ylim(df_data))
lines(makeTS(df_data, 2))
plot(makeTS(smoothed_state_variance, 2), plot.type="single", ylab="", xlab="Days", main = "(iv)", font.main=1, cex.main=1,  ylim=create_ylim(smoothed_state_variance))
}
plotSix <- function(df_data, df_filtered, df_forecasts){
"
Goal: Plot Forecasting 2.6
Input: df_kalman_filtered_state, df_forecasting
Output: Plot 2.6
"
n <- nrow(df_filtered)
j <- nrow(df_forecasts)
forecast_state <- c(df_filtered$a[2:n], df_forecasts$a_forecast[1:j])
forecast_state_lb <- df_forecasts$a_lb_forecast[1:j]
forecast_state_ub <- df_forecasts$a_ub_forecast[1:j]
forecast_variance <- c(df_filtered$P[2:n], df_forecasts$P_forecast[1:j])
forecast_observation <- c(df_filtered$a[2:n], df_forecasts$a_forecast[1:j])
forecast_error_variance <- c(df_filtered$F[2:n], df_forecasts$F_forecast[1:j])
par(mfrow=c(2,2),mar=c(4.1,4.1,1.1,2.1))
plot(makeTS(forecast_state, 2), plot.type="single", ylab="", xlab="", main = "(i)",font.main=1, cex.main=1,  ylim=c(30000,200000))
lines(ts(forecast_state_lb, start=c(101,1)), col="red")
lines(ts(forecast_state_ub, start=c(101,1)), col="red")
points(makeTS(df_data, 2), pch=20)
plot(makeTS(forecast_variance, 2), plot.type="single", ylab="", xlab="",main = "(ii)",font.main=1, cex.main=1,  ylim=create_ylim(forecast_variance))
plot(makeTS(forecast_observation, 2), plot.type="single", ylab="", xlab="Days", main = "(iii)",font.main=1, cex.main=1,  ylim=create_ylim(forecast_observation))
plot(makeTS(forecast_error_variance, 2), plot.type="single", ylab="", xlab="Days", main = "(iv)",font.main=1, cex.main=1,  ylim=create_ylim(forecast_error_variance))
}
plotSeven <- function(df){
"
Goal: Plot Diagnostic Plots prediction errors 2.7
Input:
Output: Plot 2.7
"
n <- nrow(df)
stv <- df[,1]
temp <- makeTS(stv, 2)
par(mfrow=c(2,2),mar=c(4.1,4.1,1.1,2.1))
plot(temp,ylab="", xlab= "Days", main = "(i)",font.main=1, cex.main=1)
abline(h=0)
hist(stv, prob=T, col = "white", main = "(ii)",font.main=1, cex.main=1,  xlab ="",ylab="", ylim=c(0,0.45))
lines(density(stv[-1]))
qqnorm(c(stv),main = "(iii)",font.main=1, cex.main=1,  pch = 1)
qqline(c(stv))
plot(acf(stv, lag.max = 10, plot=F), xlim=c(1,10), ylim=c(-1, 2),ci = 0)
title("(iv)", cex.main = .75, font.main =1)
}
plotEight <- function(df_st_residuals, df_7output){
"
Goal: Plot Diagnostic Plots auxilliary residuals 2.8
Input:
Output: Plot 2.8
"
length <- nrow(df_st_residuals)
stv <- df_predictionerrors[-1,1]
u_star <- makeTS(df_st_residuals[-1,1], 2)
r_star <- makeTS(df_st_residuals[-1,2], 2)
par(mfrow=c(2,2),mar=c(4.1,4.1,1.1,2.1))
plot(u_star,xlab="",ylab="",
main = "(i)",font.main=1, cex.main=1)
abline(h=0)
hist(df_st_residuals[-1,1], prob=T, bins = 25, col = "white" ,main = "(ii)",font.main=1, cex.main=1, xlab="",ylab="", na.rm=TRUE)
lines(density(u_star, na.rm=TRUE), na.rm=TRUE)
plot(r_star,ylab="",xlab="Days" ,main = "(iii)",font.main=1, cex.main=1)
abline(h=0)
hist(df_st_residuals[,2], col = "white", prob=T, main = "(iv)",font.main=1, cex.main=1,
ylim=c(0,1.2),xlab="Theoretical Quantiles",ylab="", na.rm=TRUE)
lines(density(r_star, na.rm=TRUE), na.rm=TRUE)
}
kalman_filter <- function(data, theta, sig_eps, sig_eta){
"
Goal: Apply the kalman filter recursion
Input: data, theta, sig_eps, sig_eta
Output: DF nx9 - data.frame(a, P, v, F, K, a_y, P_y, a_lb, a_ub)
"
y <- as.matrix(data)
n <- nrow(y)
a <- rep(0,n)   # filter estimator
P <- rep(0,n)   # variance of filtered estimator
v <- rep(0,n)   # prediction error
F <- rep(0,n)   # variance of prediction error
K <- rep(0,n)   # kalman gain
a_y <- rep(0,n) # one-step ahead estimator
P_y <- rep(0,n) # variance of one-step ahead estimator
a[1] <- theta[1]
P[1] <- theta[2]
for (i in 1:n) {
F[i] <- P[i] + sig_eps
v[i] <- y[i] - a[i]
if(is.nan(y[i]) || is.na(y[i])){
K[i] <- 0
a_y[i] <- a[i]
P_y[i] <- P[i]
if(i < (n-1)){
a[i+1] <- a[i]
P[i+1] <- P[i] + sig_eta
}
} else{
K[i] <- P[i]/F[i]
a_y[i] <- a[i] + K[i]*v[i]
P_y[i] <- P[i]*(1 - K[i])
if(i < (n-1)){
a[i+1] <- a[i] + K[i]*v[i]
P[i+1] <- P[i]*(1 - K[i]) + sig_eta
}
a[n] <- a[n-1] + K[n-1]*v[n-1]
P[n] <- P[n-1]*(1 - K[n-1]) + sig_eta
}
# Upper and lower bounds of a
a_lb <- a-1.645*sqrt(P)
a_ub <- a+1.645*sqrt(P)
kalman <- data.frame(a, P, v, F, K, a_y, P_y, a_lb, a_ub)
return(kalman)
}
smoothed_state <- function(df_data, df_kf){
"
Goal: Compute smoothed state through reverse loop
Input: df_kf (output of kalman filter function)
Output: DF nx6 - data.frame(alpha, N, r, V, alpha_lb, alpha_ub)
"
y <- as.matrix(df_data)
a <- df_kf$a
P <- df_kf$P
v <- df_kf$v
F <- df_kf$F
K <- df_kf$K
n <- length(v)
alpha <- rep(0, n) # smoothed stated
N <- rep(0, n)     # smoothed state error variance
r <- rep(0, n)
V <- rep(0, n)     # smoothed state variance
L <- 1-K
N[n] <- 0
r[n] <- 0
for (j in n:2){ #backward recursion
N[j-1] <- (1/F[j]) + (L[j]^2) * N[j]
V[j] <- P[j] - (P[j]^2)*N[j-1]
if (is.nan(y[j]) || is.na(y[j])){
N[j-1] <- N[j]
V[j] <- P[j] - (P[j]^2)*N[j-1]
r[j-1] <- r[j]
}
else {
r[j-1] <- (v[j]/F[j]) + L[j]*r[j]
}
alpha[j] <- a[j] + P[j]*r[j-1]
}
N[1] <- (1/F[2]) + (L[2]^2) * N[2]
N_0 <- (1/F[1]) + (L[1]^2) * N[1]
V[1] <- P[1] - (P[1]^2)*N_0
r_0 <- (v[1]/F[1]) + L[1]*r[1]
alpha[1] <- a[1] + P[1]*r_0
#upper and lower bounds of alpha
alpha_lb <- alpha - 1.645*sqrt(V)
alpha_ub <- alpha + 1.645*sqrt(V)
SmoothedState_df <- data.frame(alpha, N, r, V, alpha_lb, alpha_ub)
return (SmoothedState_df)
}
disturbances_smoothing <- function(dfKalman, dfSmoothed){
"
Goal: Apply disturbance smoothing
Input: df_kalman_filtered_state,df_smoothed_state (output of kalman, smoothedstate functions)
Output: DF 100x4 - data.frame(eps,eta,sd_eps,sd_eta)
"
F <- dfKalman$F
V <- dfKalman$v
K <- dfKalman$K
r <- dfSmoothed$r
N <- dfSmoothed$N
u <- 1/F*V-K*r
eps <- sig_eps*u
D <- 1/F + K^2*N
var_eps <- sig_eps - sig_eps^2*D
eta <- sig_eta*r
var_eta <- sig_eta - sig_eta^2*N
sd_eps <- sqrt(var_eps)
sd_eta <- sqrt(var_eta)
disturbance <- data.frame(eps, eta, sd_eps, sd_eta)
return(disturbance)
}
create_ylim <- function(vector){
"
Goal: Create min-max range from data
Input: Vector
Output: List c(min, max)
"
return(c(min(vector, na.rm=TRUE), max(vector, na.rm=TRUE)))
}
makeTS <- function(vector, c){
"
Goal: Convert vector into time series starting in 1871
Input: Vector
Output: Time series
"
if(c==1){
ts <- ts(vector, start=c(1871, 1))
} else{
ts <-ts(vector, start=c(1970, 1))
}
return(ts)
}
one_step_forecasting <- function(dfkalman, j_steps){
n <- nrow(dfkalman)
yearWithForecast <- seq(n + j_steps)
a_forecast <- rep(0, j_steps)
P_forecast <- rep(0, j_steps)
F_forecast <- rep(0, j_steps)
a_forecast[1] <- array(dfkalman$a)[n]
P_forecast[1] <- array(dfkalman$P)[n] + sig_eta
for (j in 1:(j_steps-1)) {
F_forecast[j] <- P_forecast[j] + sig_eps
a_forecast[j+1] <- a_forecast[j]
P_forecast[j+1] <- P_forecast[j] + sig_eta
}
F_forecast[j_steps] <- P_forecast[j_steps] + sig_eps
a_lb_forecast <- a_forecast - 0.675*sqrt(F_forecast)
a_ub_forecast <- a_forecast + 0.675*sqrt(F_forecast)
forecast <- data.frame(a_forecast, P_forecast, F_forecast, a_lb_forecast, a_ub_forecast)
return(forecast)
}
prediction_errors <- function(v,F){
n <- length(v)
sfe <- rep(0,n) # Standardised forecast error
for (i in 1: n) {
sfe[i] <- v[i]/sqrt(F[i])
}
st_error <- data.frame(sfe,v,F)
return(st_error)
}
stand_smooth_residuals <- function(F, v, K, r, N){
u <- 1/F*v-K*r
D <- 1/F+K^2*N
u_star <-u/sqrt(D)
r_star <- r/sqrt(N)
df_st_residuals <- data.frame(u_star, r_star)
return(df_st_residuals)
}
########### PARAMETER ESTIMATION ###################
kalman_parameter_optimizer <- function(df_data, phi_ini){
results <- optim(par=phi_ini, fn=function(par) - gauss_loglik_dc(par, df_data), method='BFGS')
q_hat <- exp(results$par)
kalman_star <- optimal_kalman_filter(df_data, q_hat)
sig_eps_hat <- calculate_sig_eps_hat(kalman_star)
sig_eta_hat <- q_hat*sig_eps_hat
theta_hat <- c(q_hat, sig_eps_hat, sig_eta_hat)
print("The parameter estimates are:")
print(round(theta_hat, 4))
print("The log-likelihood value is:")
print(results$value)
print("iterations:")
print(results$counts[1])
cat("Exit flag:")
print(results$convergence) # zero indicates succesfull optimization
return(theta_hat)
}
optimal_kalman_filter <- function(df_data, q){
y <- as.matrix(df_data)
n <- length(y)
a <- rep(0, n)     # smoothed state error variance
v <- rep(0, n)
F_star <- rep(0, n)     # smoothed state variance
P_star <- rep(0, n)
K <- rep(0, n)
a[2] <- y[1]
P_star[2] <- q + 1
for(t in 2:n){
v[t] <- y[t] - a[t]
F_star[t] <- P_star[t] + 1
K[t] <- P_star[t]/F_star[t]
a[t+1] <- a[t] + K[t]*v[t]
P_star[t+1] <- P_star[t]*(1 - K[t]) + q
}
kalman_star <- data.frame(v[2:n], F_star[2:n])
return(kalman_star)
}
calculate_sig_eps_hat <- function(kalman_star){
n <- nrow(kalman_star)
F_star <- kalman_star$F_star
v <- kalman_star$v
sig_eps <- (1/(n - 1))*sum((v^2)/F_star)
return(sig_eps)
}
gauss_loglik_dc <- function(theta, data){
y <- as.matrix(data)
n <- length(y)
phi <- theta
q <- exp(phi)
kalman_star <- optimal_kalman_filter(data, q)
F_star <- kalman_star$F_star
sig_eps <- calculate_sig_eps_hat(kalman_star)
loglik <- -(n/2)*log(2*pi) - ((n-1)/2) - ((n-1)/2)*(log(sig_eps)) - (1/2)*sum(log(F_star))
return(loglik)
}
=======
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
plotOne(ts_cars, df_kalman_filtered_state)
plotTwo(ts_cars, df_smoothed_state)
plotThree(df_disturbance)
plotFive(df_data_missing, df_kalman_missing_data, df_smoothed_state_missing_data)
plotSix(ts_cars, df_kalman_filtered_state, df_forecasts)
plotSeven(df_predictionerrors)
plotEight(df_st_residuals, df_predictionerrors)
View(ts_cars)
data <- Nile
ts_cars = read_delim(here('Data', 'UKdriversKSI.dat'), delim = "\n") %>% pull(1) %>% as_tibble() %>% slice(93:192) %>% ts()
missing_values_index <- c(21:40, 61:80)
df_data_missing <- ts_cars
df_data_missing[missing_values_index] <- NA
>>>>>>> Stashed changes
"
Time Series Models
Assignment 1
Authors:
Zeus Paraguas
Bart
Jari
Nouri Mabrouk 2623401
This code applies CH 2 of the book including the figures presented to our own time series
"
rm(list=ls())
setwd(here())
# Imports ----------
library(here)
<<<<<<< Updated upstream
source("Functions.R")
source("Plotting.R")
library(tidyverse)
library(lubridate)
options(warn=-1)
# Data import--------
ts_flights
df_flights <- read_csv(here('Data', 'total-number-of-flights.csv'))
dates = df_flights %>% slice(32:131) %>% select(1) %>% transmute(date = as.Date(DateTime, format="%d/%m/%y")) %>% pull()
ts_flights <-  df_flights%>%
select(2) %>% slice(32:131) %>% ts()
phi_ini <- 0
param_hat <- kalman_parameter_optimizer(ts_flights, phi_ini)
sig_eps <- param_hat[2]
sig_eta <- param_hat[3]
=======
source("functions.R")
source("plotting.R")
library(tidyverse)
options(warn=-1)
# Data import--------
ts_cars = read_delim(here('Data', 'UKdriversKSI.dat'), delim = "\n") %>% pull(1) %>% as_tibble() %>% slice(93:192) %>% ts()
# DEFINE theta, sig_eps, sig_eta
phi_ini <- 0
param_hat <- kalman_parameter_optimizer(ts_cars, phi_ini)
sig_eps <- param_hat[2]
sig_eta <- param_hat[3]
a_ini <- 0
P_ini <- 10^7
theta <- c(a_ini, P_ini)
df_kalman_filtered_state <- kalman_filter(ts_cars, theta, sig_eps, sig_eta)
df_smoothed_state <- smoothed_state(ts_cars, df_kalman_filtered_state)
df_disturbance <- disturbances_smoothing(df_kalman_filtered_state, df_smoothed_state)
missing_values_index <- c(21:40, 61:80)
df_data_missing <- ts_cars
df_data_missing[missing_values_index] <- NA
df_kalman_missing_data <- kalman_filter(df_data_missing, theta, sig_eps, sig_eta)
df_smoothed_state_missing_data <- smoothed_state(df_data_missing, df_kalman_missing_data)
df_disturbance_missing_data <- disturbances_smoothing(df_kalman_missing_data, df_smoothed_state_missing_data)
n_steps <- 30
df_forecasts <- one_step_forecasting(df_kalman_filtered_state, n_steps)
df_predictionerrors <- prediction_errors(df_kalman_filtered_state$v, df_kalman_filtered_state$F)
df_st_residuals <- stand_smooth_residuals(df_kalman_filtered_state$F,df_kalman_filtered_state$v,
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
plotOne(ts_cars, df_kalman_filtered_state)
plotTwo(ts_cars, df_smoothed_state)
plotThree(df_disturbance)
plotFive(df_data_missing, df_kalman_missing_data, df_smoothed_state_missing_data)
plotSix(ts_cars, df_kalman_filtered_state, df_forecasts)
plotSeven(df_predictionerrors)
plotEight(df_st_residuals, df_predictionerrors)
View(df_kalman_filtered_state)
View(df_kalman_filtered_state)
"
Time Series Models
Assignment 1
Authors:
Zeus Paraguas
Bart
Jari
Nouri Mabrouk 2623401
This code applies CH 2 of the book including the figures presented to our own time series
"
rm(list=ls())
setwd(here())
# Imports ----------
library(here)
source("functions.R")
source("plotting.R")
library(tidyverse)
options(warn=-1)
# Data import--------
ts_flights <- read_csv(here('Data', 'total-number-of-flights.csv')) %>%
select(2) %>% slice(32:131) %>% ts()
#ts_flights <- Nile
# DEFINE theta, sig_eps, sig_eta
phi_ini <- 0
param_hat <- kalman_parameter_optimizer(ts_flights, phi_ini)
sig_eps <- param_hat[2]
sig_eta <- param_hat[3]
a_ini <- 0
P_ini <- 10^5
theta <- c(a_ini, P_ini)
df_kalman_filtered_state <- kalman_filter(ts_flights, theta, sig_eps, sig_eta)
df_smoothed_state <- smoothed_state(ts_flights, df_kalman_filtered_state)
df_disturbance <- disturbances_smoothing(df_kalman_filtered_state, df_smoothed_state)
missing_values_index <- c(21:40, 61:80)
df_data_missing <- ts_flights
df_data_missing[missing_values_index] <- NA
df_kalman_missing_data <- kalman_filter(df_data_missing, theta, sig_eps, sig_eta)
df_smoothed_state_missing_data <- smoothed_state(df_data_missing, df_kalman_missing_data)
df_disturbance_missing_data <- disturbances_smoothing(df_kalman_missing_data, df_smoothed_state_missing_data)
n_steps <- 30
df_forecasts <- one_step_forecasting(df_kalman_filtered_state, n_steps)
df_predictionerrors <- prediction_errors(df_kalman_filtered_state$v, df_kalman_filtered_state$F)
df_st_residuals <- stand_smooth_residuals(df_kalman_filtered_state$F,df_kalman_filtered_state$v,
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
plotOne(ts_flights, df_kalman_filtered_state)
plotTwo(ts_flights, df_smoothed_state)
plotThree(df_disturbance)
plotFive(df_data_missing, df_kalman_missing_data, df_smoothed_state_missing_data)
plotSix(ts_flights, df_kalman_filtered_state, df_forecasts)
plotSeven(df_predictionerrors)
plotEight(df_st_residuals, df_predictionerrors)
"
Time Series Models
Assignment 1
Authors:
Zeus Paraguas
Bart
Jari
Nouri Mabrouk 2623401
This code applies CH 2 of the book including the figures presented to our own time series
"
rm(list=ls())
setwd(here())
# Imports ----------
library(here)
source("functions.R")
source("plotting.R")
library(tidyverse)
options(warn=-1)
# Data import--------
ts_flights <- read_csv(here('Data', 'total-number-of-flights.csv')) %>%
select(2) %>% slice(32:131) %>% ts()
#ts_flights <- Nile
# DEFINE theta, sig_eps, sig_eta
phi_ini <- 0
param_hat <- kalman_parameter_optimizer(ts_flights, phi_ini)
sig_eps <- param_hat[2]
sig_eta <- param_hat[3]
a_ini <- 0
P_ini <- 10^5
theta <- c(a_ini, P_ini)
df_kalman_filtered_state <- kalman_filter(ts_flights, theta, sig_eps, sig_eta)
df_smoothed_state <- smoothed_state(ts_flights, df_kalman_filtered_state)
df_disturbance <- disturbances_smoothing(df_kalman_filtered_state, df_smoothed_state)
missing_values_index <- c(21:40, 61:80)
df_data_missing <- ts_flights
df_data_missing[missing_values_index] <- NA
df_kalman_missing_data <- kalman_filter(df_data_missing, theta, sig_eps, sig_eta)
df_smoothed_state_missing_data <- smoothed_state(df_data_missing, df_kalman_missing_data)
df_disturbance_missing_data <- disturbances_smoothing(df_kalman_missing_data, df_smoothed_state_missing_data)
n_steps <- 30
df_forecasts <- one_step_forecasting(df_kalman_filtered_state, n_steps)
df_predictionerrors <- prediction_errors(df_kalman_filtered_state$v, df_kalman_filtered_state$F)
df_st_residuals <- stand_smooth_residuals(df_kalman_filtered_state$F,df_kalman_filtered_state$v,
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
plotOne(ts_flights, df_kalman_filtered_state)
plotTwo(ts_flights, df_smoothed_state)
plotThree(df_disturbance)
plotFive(df_data_missing, df_kalman_missing_data, df_smoothed_state_missing_data)
plotSix(ts_flights, df_kalman_filtered_state, df_forecasts)
plotSeven(df_predictionerrors)
plotEight(df_st_residuals, df_predictionerrors)
"
Time Series Models
Assignment 1
Authors:
Zeus Paraguas
Bart
Jari
Nouri Mabrouk 2623401
This code applies CH 2 of the book including the figures presented to our own time series
"
rm(list=ls())
setwd(here())
# Imports ----------
library(here)
source("functions.R")
source("plotting.R")
library(tidyverse)
options(warn=-1)
# Data import--------
ts_cars = read_delim(here('Data', 'UKdriversKSI.dat'), delim = "\n") %>% pull(1) %>% as_tibble() %>% slice(93:192) %>% ts()
# DEFINE theta, sig_eps, sig_eta
phi_ini <- 0
param_hat <- kalman_parameter_optimizer(ts_cars, phi_ini)
sig_eps <- param_hat[2]
sig_eta <- param_hat[3]
a_ini <- 0
P_ini <- 10^5
theta <- c(a_ini, P_ini)
df_kalman_filtered_state <- kalman_filter(ts_cars, theta, sig_eps, sig_eta)
df_smoothed_state <- smoothed_state(ts_cars, df_kalman_filtered_state)
df_disturbance <- disturbances_smoothing(df_kalman_filtered_state, df_smoothed_state)
missing_values_index <- c(21:40, 61:80)
df_data_missing <- ts_cars
df_data_missing[missing_values_index] <- NA
df_kalman_missing_data <- kalman_filter(df_data_missing, theta, sig_eps, sig_eta)
df_smoothed_state_missing_data <- smoothed_state(df_data_missing, df_kalman_missing_data)
df_disturbance_missing_data <- disturbances_smoothing(df_kalman_missing_data, df_smoothed_state_missing_data)
n_steps <- 30
df_forecasts <- one_step_forecasting(df_kalman_filtered_state, n_steps)
df_predictionerrors <- prediction_errors(df_kalman_filtered_state$v, df_kalman_filtered_state$F)
df_st_residuals <- stand_smooth_residuals(df_kalman_filtered_state$F,df_kalman_filtered_state$v,
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
plotOne(ts_cars, df_kalman_filtered_state)
plotTwo(ts_cars, df_smoothed_state)
plotThree(df_disturbance)
plotFive(df_data_missing, df_kalman_missing_data, df_smoothed_state_missing_data)
plotSix(ts_cars, df_kalman_filtered_state, df_forecasts)
plotSeven(df_predictionerrors)
plotEight(df_st_residuals, df_predictionerrors)
rm(list=ls())
setwd(here())
"
Time Series Models
Assignment 1
Authors:
Zeus Paraguas
Bart
Jari
Nouri Mabrouk 2623401
Main file to run the analysis
"
rm(list=ls())
setwd(here())
# Imports ----------
library(here)
source("functions.R")
source("plotting.R")
library(tidyverse)
options(warn=-1)
# Data import--------
ts_Nile = Nile
# 2.1 Kalman Filter
# Initialises values
# Applies Kalman Filter
# Plots results (figure 2.1)
phi_ini <- 0
parameter_estimation <- kalman_parameter_optimizer(df_data, phi_ini)
q_hat <- exp(parameter_estimation$par)
kalman_star <- optimal_kalman_filter(df_data, q_hat)
sig_eps_hat <- calcualte_sig_eps_hat(kalman_star)
sig_eta_hat <- q_hat*sig_eps_hat
theta_hat <- c(q_hat, sig_eps_hat, sig_eta_hat)
cat("The parameter estimates are:")
round(theta_hat, 4)
cat("The log-likelihood value is:")
parameter_estimation$value
cat("iterations:")
parameter_estimation$counts[1]
cat("Exit flag:")
parameter_estimation$convergence # zero indicates succesfull optimization
sig_eps <- 15099
sig_eta <- 1469.1
>>>>>>> Stashed changes
a_ini <- 0
P_ini <- 10^5
theta <- c(a_ini, P_ini)
<<<<<<< Updated upstream
#2.1
df_kalman_filtered_state <- kalman_filter(ts_flights, theta, sig_eps, sig_eta)
#2.2
df_smoothed_state <- smoothed_state(ts_flights, df_kalman_filtered_state)
#2.3
df_disturbance <- disturbances_smoothing(df_kalman_filtered_state, df_smoothed_state)
#2.5
=======
df_kalman_filtered_state <- kalman_filter(ts_Nile, theta, sig_eps, sig_eta)
plotOne(df_kalman_filtered_state)
# 2.2  Smoothed State
# Creates figure 2.2
df_smoothed_state <- smoothed_state(ts_Nile, df_kalman_filtered_state)
plotTwo(df_smoothed_state)
# 2.3 Disturbance Smoothing
# Creates figure 2.3
df_disturbance <- disturbances_smoothing(df_kalman_filtered_state, df_smoothed_state)
plotThree(df_disturbance)
# 2.5 Missing data
# Creates missing data
# Runs Kalman filter, state smoother, and disturbance smoother
# Creates figure 2.5
>>>>>>> Stashed changes
missing_values_index <- c(21:40, 61:80)
df_data_missing <- ts_flights
df_data_missing[missing_values_index] <- NA
df_kalman_missing_data <- kalman_filter(df_data_missing, theta, sig_eps, sig_eta)
df_smoothed_state_missing_data <- smoothed_state(df_data_missing, df_kalman_missing_data)
df_disturbance_missing_data <- disturbances_smoothing(df_kalman_missing_data, df_smoothed_state_missing_data)
<<<<<<< Updated upstream
#2.6
n_steps <- 30
df_forecasts <- one_step_forecasting(df_kalman_filtered_state, n_steps)
#2.7
df_predictionerrors <- prediction_errors(df_kalman_filtered_state$v, df_kalman_filtered_state$F)
#2.8
df_st_residuals <- stand_smooth_residuals(df_kalman_filtered_state$F,df_kalman_filtered_state$v,
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
#Plot results
plotOne(ts_flights[-1,], df_kalman_filtered_state[-1,])
plotTwo(ts_flights, df_smoothed_state)
plotThree(df_disturbance %>% slice(-c(1,2)))
plotFive(df_data_missing[-1,], df_kalman_missing_data %>% slice(-1), df_smoothed_state_missing_data %>% slice(-1))
plotSix(ts_flights[-1,], df_kalman_filtered_state[-1,], df_forecasts[-1,])
plotSeven(df_predictionerrors %>% slice(-c(1:2)))
plotEight(df_st_residuals %>% slice(-1), df_predictionerrors %>% slice(-1))
sv <- read.delim(here('Data', 'sv.dat'))
=======
plotFive(df_data_missing, df_kalman_missing_data, df_smoothed_state_missing_data)
# 2.6
# Forecasting
# Creates figure 2.6
n_steps <- 30
df_forecasts <- one_step_forecasting(df_kalman_filtered_state, n_steps)
plotSix(ts_Nile, df_kalman_filtered_state, df_forecasts)
# 2.7
# Standardised prediction errors
# Creates figure 2.7
df_predictionerrors <- prediction_errors(df_kalman_filtered_state$v, df_kalman_filtered_state$F)
plotSeven(df_predictionerrors)
# 2.8
# Standardized smoothed residuals
# Creates figure 2.8
df_st_residuals <- stand_smooth_residuals(df_kalman_filtered_state$F,df_kalman_filtered_state$v,
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
plotEight(df_st_residuals, df_predictionerrors)
df_kalman_filtered_state <- kalman_filter(ts_Nile, theta, sig_eps, sig_eta)
plotOne(df_kalman_filtered_state)
"
Time Series Models
Assignment 1
Authors:
Zeus Paraguas
Bart
Jari
Nouri Mabrouk 2623401
This code applies CH 2 of the book including the figures presented to our own time series
"
rm(list=ls())
setwd(here())
# Imports ----------
library(here)
source("functions.R")
source("plotting.R")
library(tidyverse)
options(warn=-1)
# Data import--------
ts_cars = read_delim(here('Data', 'UKdriversKSI.dat'), delim = "\n") %>% pull(1) %>% as_tibble() %>% slice(93:192) %>% ts()
# DEFINE theta, sig_eps, sig_eta
phi_ini <- 0
param_hat <- kalman_parameter_optimizer(ts_cars, phi_ini)
sig_eps <- param_hat[2]
sig_eta <- param_hat[3]
a_ini <- 0
P_ini <- 10^7
theta <- c(a_ini, P_ini)
df_kalman_filtered_state <- kalman_filter(ts_cars, theta, sig_eps, sig_eta)
df_smoothed_state <- smoothed_state(ts_cars, df_kalman_filtered_state)
df_disturbance <- disturbances_smoothing(df_kalman_filtered_state, df_smoothed_state)
missing_values_index <- c(21:40, 61:80)
df_data_missing <- ts_cars
df_data_missing[missing_values_index] <- NA
df_kalman_missing_data <- kalman_filter(df_data_missing, theta, sig_eps, sig_eta)
df_smoothed_state_missing_data <- smoothed_state(df_data_missing, df_kalman_missing_data)
df_disturbance_missing_data <- disturbances_smoothing(df_kalman_missing_data, df_smoothed_state_missing_data)
n_steps <- 30
df_forecasts <- one_step_forecasting(df_kalman_filtered_state, n_steps)
df_predictionerrors <- prediction_errors(df_kalman_filtered_state$v, df_kalman_filtered_state$F)
df_st_residuals <- stand_smooth_residuals(df_kalman_filtered_state$F,df_kalman_filtered_state$v,
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
plotOne(ts_cars, df_kalman_filtered_state)
plotTwo(ts_cars, df_smoothed_state)
plotThree(df_disturbance)
plotFive(df_data_missing, df_kalman_missing_data, df_smoothed_state_missing_data)
plotSix(ts_cars, df_kalman_filtered_state, df_forecasts)
plotSeven(df_predictionerrors)
plotEight(df_st_residuals, df_predictionerrors)
>>>>>>> Stashed changes
"
Time Series Models
Assignment 1
Authors:
Zeus Paraguas
Bart
Jari
Nouri Mabrouk 2623401
This code applies CH 2 of the book including the figures presented to our own time series
"
rm(list=ls())
<<<<<<< Updated upstream
# Imports ----------
source("Functions.R")
source("Plotting.R")
library(here)
library(tidyverse)
library(lubridate)
library(scales)
library(ggplot2)
setwd(here())
options(warn=-1)
# Data import--------
df_flights <- read_csv(here('Data', 'total-number-of-flights.csv'))
sv <- read.delim(here('Data', 'sv.dat'))
data <- sv %>% as_tibble() %>% rename(x = X...Pound.Dollar.daily.exchange.rates..sections.9.6.and.14.4)
data
=======
setwd(here())
# Imports ----------
library(here)
source("functions.R")
source("plotting.R")
library(tidyverse)
options(warn=-1)
# Data import--------
ts_cars = read_delim(here('Data', 'UKdriversKSI.dat'), delim = "\n") %>% pull(1) %>% as_tibble() %>% slice(93:192) %>% ts()
# DEFINE theta, sig_eps, sig_eta
phi_ini <- 0
param_hat <- kalman_parameter_optimizer(ts_cars, phi_ini)
sig_eps <- param_hat[2]
sig_eta <- param_hat[3]
a_ini <- 0
P_ini <- 10^7
theta <- c(a_ini, P_ini)
df_kalman_filtered_state <- kalman_filter(ts_cars, theta, sig_eps, sig_eta)
df_smoothed_state <- smoothed_state(ts_cars, df_kalman_filtered_state)
df_disturbance <- disturbances_smoothing(df_kalman_filtered_state, df_smoothed_state)
missing_values_index <- c(21:40, 61:80)
df_data_missing <- ts_cars
df_data_missing[missing_values_index] <- NA
df_kalman_missing_data <- kalman_filter(df_data_missing, theta, sig_eps, sig_eta)
df_smoothed_state_missing_data <- smoothed_state(df_data_missing, df_kalman_missing_data)
df_disturbance_missing_data <- disturbances_smoothing(df_kalman_missing_data, df_smoothed_state_missing_data)
n_steps <- 30
df_forecasts <- one_step_forecasting(df_kalman_filtered_state, n_steps)
df_predictionerrors <- prediction_errors(df_kalman_filtered_state$v, df_kalman_filtered_state$F)
df_st_residuals <- stand_smooth_residuals(df_kalman_filtered_state$F,df_kalman_filtered_state$v,
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
plotOne(ts_cars, df_kalman_filtered_state)
plotTwo(ts_cars, df_smoothed_state)
plotThree(df_disturbance)
plotFive(df_data_missing, df_kalman_missing_data, df_smoothed_state_missing_data)
plotSix(ts_cars, df_kalman_filtered_state, df_forecasts)
plotSeven(df_predictionerrors)
plotEight(df_st_residuals, df_predictionerrors)
"
Time Series Models
Assignment 1
Authors:
Zeus Paraguas
Bart
Jari
Nouri Mabrouk 2623401
This code applies CH 2 of the book including the figures presented to our own time series
"
rm(list=ls())
setwd(here())
# Imports ----------
library(here)
source("functions.R")
source("plotting.R")
library(tidyverse)
options(warn=-1)
# Data import--------
ts_cars = read_delim(here('Data', 'UKdriversKSI.dat'), delim = "\n") %>% pull(1) %>% as_tibble() %>% slice(93:192) %>% ts()
ts_cars <- Nile
# DEFINE theta, sig_eps, sig_eta
phi_ini <- 0
param_hat <- kalman_parameter_optimizer(ts_cars, phi_ini)
sig_eps <- param_hat[2]
sig_eta <- param_hat[3]
a_ini <- 0
P_ini <- 10^7
theta <- c(a_ini, P_ini)
df_kalman_filtered_state <- kalman_filter(ts_cars, theta, sig_eps, sig_eta)
df_smoothed_state <- smoothed_state(ts_cars, df_kalman_filtered_state)
df_disturbance <- disturbances_smoothing(df_kalman_filtered_state, df_smoothed_state)
missing_values_index <- c(21:40, 61:80)
df_data_missing <- ts_cars
df_data_missing[missing_values_index] <- NA
df_kalman_missing_data <- kalman_filter(df_data_missing, theta, sig_eps, sig_eta)
df_smoothed_state_missing_data <- smoothed_state(df_data_missing, df_kalman_missing_data)
df_disturbance_missing_data <- disturbances_smoothing(df_kalman_missing_data, df_smoothed_state_missing_data)
n_steps <- 30
df_forecasts <- one_step_forecasting(df_kalman_filtered_state, n_steps)
df_predictionerrors <- prediction_errors(df_kalman_filtered_state$v, df_kalman_filtered_state$F)
df_st_residuals <- stand_smooth_residuals(df_kalman_filtered_state$F,df_kalman_filtered_state$v,
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
plotOne(ts_cars, df_kalman_filtered_state)
plotTwo(ts_cars, df_smoothed_state)
plotThree(df_disturbance)
plotFive(df_data_missing, df_kalman_missing_data, df_smoothed_state_missing_data)
plotSix(ts_cars, df_kalman_filtered_state, df_forecasts)
plotSeven(df_predictionerrors)
plotEight(df_st_residuals, df_predictionerrors)
"
Time Series Models
Assignment 1
Authors:
Zeus Paraguas
Bart
Jari
Nouri Mabrouk 2623401
This code applies CH 2 of the book including the figures presented to our own time series
"
rm(list=ls())
setwd(here())
# Imports ----------
library(here)
source("functions.R")
source("plotting.R")
library(tidyverse)
options(warn=-1)
# Data import--------
ts_cars = read_delim(here('Data', 'UKdriversKSI.dat'), delim = "\n") %>% pull(1) %>% as_tibble() %>% slice(93:192) %>% ts()
#ts_cars <- Nile
# DEFINE theta, sig_eps, sig_eta
phi_ini <- 0
param_hat <- kalman_parameter_optimizer(ts_cars, phi_ini)
sig_eps <- param_hat[2]
sig_eta <- param_hat[3]
a_ini <- 0
P_ini <- 10^7
theta <- c(a_ini, P_ini)
df_kalman_filtered_state <- kalman_filter(ts_cars, theta, sig_eps, sig_eta)
df_smoothed_state <- smoothed_state(ts_cars, df_kalman_filtered_state)
df_disturbance <- disturbances_smoothing(df_kalman_filtered_state, df_smoothed_state)
missing_values_index <- c(21:40, 61:80)
df_data_missing <- ts_cars
df_data_missing[missing_values_index] <- NA
df_kalman_missing_data <- kalman_filter(df_data_missing, theta, sig_eps, sig_eta)
df_smoothed_state_missing_data <- smoothed_state(df_data_missing, df_kalman_missing_data)
df_disturbance_missing_data <- disturbances_smoothing(df_kalman_missing_data, df_smoothed_state_missing_data)
n_steps <- 30
df_forecasts <- one_step_forecasting(df_kalman_filtered_state, n_steps)
df_predictionerrors <- prediction_errors(df_kalman_filtered_state$v, df_kalman_filtered_state$F)
df_st_residuals <- stand_smooth_residuals(df_kalman_filtered_state$F,df_kalman_filtered_state$v,
df_kalman_filtered_state$K, df_smoothed_state$r,
df_smoothed_state$N)
plotOne(ts_cars, df_kalman_filtered_state)
plotTwo(ts_cars, df_smoothed_state)
plotThree(df_disturbance)
plotFive(df_data_missing, df_kalman_missing_data, df_smoothed_state_missing_data)
plotSix(ts_cars, df_kalman_filtered_state, df_forecasts)
plotSeven(df_predictionerrors)
plotEight(df_st_residuals, df_predictionerrors)
View(df_smoothed_state)
View(df_kalman_filtered_state)
>>>>>>> Stashed changes
